<?xml version="1.0"?>

<robot xmlns:xacro="http://ros.org/wiki/xacro">

  <!-- Main multirotor link -->
  <xacro:macro name="multirotor_base_macro" params="robot_namespace mass body_width body_height *inertia">
    <link name="base_link">
      <inertial>
        <mass value="${mass}" />  <!-- [kg] -->
        <origin xyz="0 0 0" />
        <xacro:insert_block name="inertia" />
      </inertial>

      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <box size="${body_width} ${body_width} ${body_height}"/> <!-- [m] [m] [m] -->
        </geometry>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <box size="${body_width} ${body_width} ${body_height}"/> <!-- [m] [m] [m] -->
        </geometry>
      </collision>
    </link>
    <gazebo>
      <plugin name="controller_interface"
        filename="libmav_gazebo_controller_interface.so">
        <robotNamespace>${robot_namespace}</robotNamespace>
        <commandTopic>mav_cmd</commandTopic>
        <imuTopic>imu</imuTopic>
        <poseTopic>pose</poseTopic>
        <motorVelocityReferenceTopic>motor_vel_ref</motorVelocityReferenceTopic>
      </plugin>
      <plugin filename="libgazebo_ros_imu.so" name="imu_ros">
        <bodyName>base_link</bodyName>
        <robotNamespace>${robot_namespace}</robotNamespace>
        <topicName>imu</topicName>
      </plugin>
    </gazebo>
  </xacro:macro>

  <!-- Rotor joint and link -->
  <xacro:macro name="vertical_rotor" params="suffix direction motor_constant moment_constant parent mass_rotor radius_rotor time_constant max_rot_velocity motor_number *origin *inertia">
    <joint name="rotor_${suffix}_joint" type="continuous">
      <xacro:insert_block name="origin" />
      <axis xyz="0 0 1" />
      <parent link="${parent}"/>
      <child link="rotor_${suffix}"/>
    </joint>
    <link name="rotor_${suffix}">
      <inertial>
        <mass value="${mass_rotor}" /> <!-- [kg] -->
        <xacro:insert_block name="inertia" />
      </inertial>
      <visual>
        <geometry>
          <cylinder length="0.005" radius="${radius_rotor}"/> <!-- [m] -->
        </geometry>
      </visual>
      <collision>
        <geometry>
          <cylinder length="0.005" radius="${radius_rotor}"/> <!-- [m] -->
        </geometry>
      </collision>
    </link>
    <gazebo>
      <plugin name="${suffix}_motor_model" filename="libmav_gazebo_motor_model.so">
        <jointName>rotor_${suffix}_joint</jointName>
        <linkName>rotor_${suffix}</linkName>
        <turningDirection>${direction}</turningDirection>
        <timeConstant>${time_constant}</timeConstant>
        <maxRotVelocity>${max_rot_velocity}</maxRotVelocity>
        <motorConstant>${motor_constant}</motorConstant>
        <momentConstant>${moment_constant}</momentConstant>
        <commandTopic>motor_vel_ref</commandTopic>
        <motorNumber>${motor_number}</motorNumber>
        <motorVelocityTopic>${suffix}_motor_vel</motorVelocityTopic>
      </plugin>
    </gazebo>
  </xacro:macro>
</robot>
